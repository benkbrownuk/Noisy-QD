<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Residual Trees</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script type="module">
    import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
    import { DecisionTreeRegressor } from "https://cdn.jsdelivr.net/npm/scikitjs@latest/dist/scikit.esm.js";

    async function run() {
      // Generate data
      const X = d3.range(-5, 5, 0.1).map(d => [d]);
      const y_true = X.map(d => Math.sin(d[0]) + 0.5 * d3.randomNormal(0, 1)());

      // First tree on noisy data
      let tree1 = new DecisionTreeRegressor({ maxDepth: 4 });
      await tree1.fit(X, y_true);
      let pred1 = await tree1.predict(X);

      // First residuals
      let residual1 = y_true.map((d, i) => d - pred1[i]);

      // Tree on residuals
      let tree2 = new DecisionTreeRegressor({ maxDepth: 4 });
      await tree2.fit(X, residual1);
      let pred_resid1 = await tree2.predict(X);

      // Corrected prediction after 2 stages
      let corrected2 = pred1.map((d, i) => d + pred_resid1[i]);

      // Second residuals
      let residual2 = y_true.map((d, i) => d - corrected2[i]);

      // Third tree on residuals
      let tree3 = new DecisionTreeRegressor({ maxDepth: 4 });
      await tree3.fit(X, residual2);
      let pred_resid2 = await tree3.predict(X);

      // Corrected prediction after 3 stages
      let corrected3 = corrected2.map((d, i) => d + pred_resid2[i]);

      // Plotting
      const width = 700, height = 400;
      const svg = d3.select("body").append("svg")
          .attr("width", width).attr("height", height);

      const xScale = d3.scaleLinear().domain([-5, 5]).range([50, width - 20]);
      const yScale = d3.scaleLinear().domain([-6, 6]).range([height - 40, 20]);

      // Axes
      svg.append("g")
         .attr("transform", `translate(0,${yScale(0)})`)
         .call(d3.axisBottom(xScale));
      svg.append("g")
         .attr("transform", `translate(${xScale(0)},0)`)
         .call(d3.axisLeft(yScale));

      // Data points (red)
      svg.selectAll("circle")
         .data(X.map((d, i) => ({x: d[0], y: y_true[i]})))
         .enter().append("circle")
         .attr("cx", d => xScale(d.x))
         .attr("cy", d => yScale(d.y))
         .attr("r", 2)
         .attr("fill", "red")
         .attr("opacity", 0.6);

      // Helper to draw step line
      function drawStepLine(data, color) {
        let line = d3.line()
            .x((d, i) => xScale(X[i][0]))
            .y((d, i) => yScale(d))
            .curve(d3.curveStepAfter);

        svg.append("path")
           .datum(data)
           .attr("fill", "none")
           .attr("stroke", color)
           .attr("stroke-width", 2)
           .attr("d", line);
      }

      // Plot residual predictors
      drawStepLine(pred_resid1, "purple");     // First residual tree
      drawStepLine(pred_resid2, "blue");       // Second residual tree
      drawStepLine(corrected3, "green");       // Final corrected predictor
    }

    run();
  </script>
</head>
<body>
  <h2>Residual Tree Predictions</h2>
</body>
</html>
